version: '3.8'

networks:
  iotnet:
    driver: overlay

services:
  grafana:
    image: grafana/grafana:latest
    hostname: grafana
    volumes:
      - /iotstackdata/grafana/data:/var/lib/grafana
      - /iotstackdata/grafana/config:/etc/grafana
      - /iotstackdata/grafana/logos:/usr/share/grafana/public/img
    environment:
      - INFLUX_TOKEN=${INFLUX_TOKEN}
    deploy:
      restart_policy:
        condition: on-failure
    networks:
      - iotnet

  telegraf:
    image: telegraf:latest
    hostname: telegraf
    volumes:
      - /iotstackdata/telegraf/telegraf.conf:/etc/telegraf/telegraf.conf
    deploy:
      restart_policy:
        condition: on-failure
    networks:
      - iotnet

  mosquitto:
    image: eclipse-mosquitto:2
    hostname: mosquitto
    volumes:
      - /iotstackdata/mosquitto/config:/mosquitto/config
      - /iotstackdata/mosquitto/data:/mosquitto/data
      - /iotstackdata/mosquitto/log:/mosquitto/log
      - /iotstackdata/mosquitto/certs:/mosquitto/certs
      - /iotstackdata/mosquitto/dynsec:/mosquitto/dynsec
    ports:
      - 8883:8883
      - 1883:1883
    deploy:
      restart_policy:
        condition: on-failure
    networks:
      - iotnet

  mqttjson2mqttline:
    image: harbor.swms-cloud.com/iiot/mqttjson2mqttline:teltonika
    hostname: mqttjson2mqttline
    volumes:
      - /iotstackdata/mqttjson2mqttline/config:/app/config
    deploy:
      restart_policy:
        condition: on-failure
    networks:
      - iotnet
